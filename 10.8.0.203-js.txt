var rowsToUpdate=new Array();var UPDATE_FREQ_SECS=5;var ChState=["Start","Night Check","Disconnect","Night","Fault","MPPT","Absorption","Float","Equalize"];var LdState=["Start","Load On","LVD Warning","LVD","Fault","Disconnect"];var ChStDisp=new EnumTextDisplayClass(SMBID,33,1,"fDChargeSt","lblSt","Charge State","lblvalSt",ChState);var Vb=new ScaledValueDisplayClass(SMBID,24,"V","V","fDBattV","Battery Voltage",1);var VbT=new ScaledValueDisplayClass(SMBID,36,"V","V","fDTargetV","Target Voltage",1);var IbC=new ScaledValueDisplayClass(SMBID,16,"A","A","fDChargeI","Charge Current",1);var Va=new ScaledValueDisplayClass(SMBID,19,"V","V","fDArrayV","Array Voltage",1);var VmpS=new ScaledValueDisplayClass(SMBID,61,"V","V","fDSweepVmp","Sweep Vmp",1);var VocS=new ScaledValueDisplayClass(SMBID,63,"V","V","fDSweepVoc","Sweep Voc",1);var Pmax=new ScaledValueDisplayClass(SMBID,62,"Wp","W","fDSweepPmax","Sweep Pmax",1);var LoadSt=new EnumTextDisplayClass(SMBID,46,1,"fDLoadState","lblSt","Load State","lblvalSt",LdState);var LoadV=new ScaledValueDisplayClass(SMBID,20,"V","V","fDLoadV","Load Voltage",1);var LoadI=new ScaledValueDisplayClass(SMBID,22,"A","A","fDLoadI","Load Current",1);var ATemp=new TempDisplayClass(SMBID,28,"fDTAmbient","Ambient");var BTemp=new TempDisplayClass(SMBID,27,"fDTBatt","Battery");var HSTemp=new TempDisplayClass(SMBID,26,"fDTHeatSink","Heat Sink");var CAhCntr=new ScaledValueDisplayClass(SMBID,40,"Ah","Ah","fDChargeAmpHr","Charge Amp Hours",2);var KwhCntr=new ScaledValueDisplayClass(SMBID,43,"kWh","kWh","fDChargeKwHr","Charge KW Hours",1);var LAhCntr=new ScaledValueDisplayClass(SMBID,52,"Ah","Ah","fDLoadAmpHr","Load Amp Hours",2);var AlarmsDisplay=new BitFieldTextDisplayClass(SMBID,56,57,1,"fDAlarms","lblAlarm","Alarms","lblvalAlarm",AlarmsArray);var ArrayFaultsDisplay=new BitFieldTextDisplayClass(SMBID,34,-1,0,"fDAlarms","lblAError","Array Faults","lblvalAError",ArrayFaultsArray);var LoadFaultsDisplay=new BitFieldTextDisplayClass(SMBID,47,-1,0,"fDAlarms","lblLError","Load Faults","lblvalLError",LoadFaultsArray);var TStamp=new TStampClass("flastU","valLastU");var Factors=new ScaleFactors();var intervalHandle=0;function LVInit(A){ShowMenu(A);Factors.Init();rowsToUpdate[rowsToUpdate.length]=ChStDisp;rowsToUpdate[rowsToUpdate.length]=Vb;rowsToUpdate[rowsToUpdate.length]=VbT;rowsToUpdate[rowsToUpdate.length]=IbC;rowsToUpdate[rowsToUpdate.length]=Va;rowsToUpdate[rowsToUpdate.length]=VmpS;rowsToUpdate[rowsToUpdate.length]=VocS;rowsToUpdate[rowsToUpdate.length]=Pmax;rowsToUpdate[rowsToUpdate.length]=ATemp;rowsToUpdate[rowsToUpdate.length]=BTemp;rowsToUpdate[rowsToUpdate.length]=HSTemp;rowsToUpdate[rowsToUpdate.length]=CAhCntr;rowsToUpdate[rowsToUpdate.length]=KwhCntr;rowsToUpdate[rowsToUpdate.length]=LAhCntr;rowsToUpdate[rowsToUpdate.length]=LoadSt;rowsToUpdate[rowsToUpdate.length]=LoadV;rowsToUpdate[rowsToUpdate.length]=LoadI;rowsToUpdate[rowsToUpdate.length]=AlarmsDisplay;rowsToUpdate[rowsToUpdate.length]=ArrayFaultsDisplay;rowsToUpdate[rowsToUpdate.length]=LoadFaultsDisplay;rowsToUpdate[rowsToUpdate.length]=TStamp;intervalHandle=setInterval(updateAllLVText,100)}function BitFieldTextDisplayClass(H,D,C,E,B,F,G,I,A){this.SMBID=H;this.MBaddress0=D;this.MBaddress1=C;this.frmName=B;this.lblName=G;this.lblCtrl=F;this.valCtrl=I;this.textArray=A;this.updateLVText=function(){try{var M=1;var K=MBJSReadModbusInts(MBP,this.SMBID.toString(),this.MBaddress0.toString(),1);if(this.MBaddress1!=-1){M=2;K=(K<<16)|MBJSReadModbusInts(MBP,this.SMBID.toString(),this.MBaddress1.toString(),1)}K=K&(~E);document.forms[this.frmName].elements[this.lblCtrl.toString()].value=this.lblName.toString();var N="";var J=0;if(K>0){while(J<(16*M)){if(K&(1<<J)){if(this.textArray.length>J){if(N!=""){N+="\n"}N+=this.textArray[J]}}J++}}else{N="None"}document.forms[this.frmName].elements[this.valCtrl.toString()].value=N;return 1}catch(L){return 0}}}function EnumTextDisplayClass(E,B,G,F,C,H,A,D){this.SMBID=E;this.MBaddress=B;this.frmName=F;this.lblName=H;this.lblCtrl=C;this.valCtrl=A;this.textArray=D;this.updateLVText=function(){try{var J=0;var J=MBJSReadModbusInts(MBP,this.SMBID.toString(),this.MBaddress.toString(),G);if(G>1){var I=J.split("#");J=(parseInt(I[0])*65536)+parseInt(I[1])}document.forms[this.frmName].elements[this.lblCtrl.toString()].value=this.lblName.toString();if(this.textArray.length>J){document.forms[this.frmName].elements[this.valCtrl.toString()].value=this.textArray[J]}return 1}catch(K){return 0}}}function TempDisplayClass(B,A,C,D){this.SMBID=B;this.MBaddress=A;this.frmName=C;this.lblName=D;this.SMBID=B;this.MBaddress=A;this.updateLVText=function(){try{var E=parseInt(MBJSReadModbusInts(MBP,this.SMBID.toString(),this.MBaddress.toString(),"1"));document.forms[this.frmName].elements.lblDataName.value=this.lblName.toString();document.forms[this.frmName].elements.lblcurrentValue.value=ScaleF16(E.toString()).toFixed(2)+" \u00B0C";return 1}catch(F){return 0}}}function TStampClass(B,A){this.frmName=B;this.valCtrlName=A;this.updateLVText=function(){try{var D=new Date();document.forms[this.frmName].elements[this.valCtrlName].value="Last Update: "+D.toUTCString();return 1}catch(C){return 0}}}function GetScaledValue(D,A,F,E){var C=0;C=MBJSReadModbusInts(MBP,D.toString(),A.toString(),E);if(E>1){var B=C.split("#");C=(parseInt(B[0])*65536)+parseInt(B[1])}else{}if(F.toString()=="V"){return(ScaleF16(C)).toFixed(2)}else{if(F.toString()=="A"){return(ScaleF16(C)).toFixed(1)}else{if(F.toString()=="Wp"){return(ScaleF16(C)).toFixed(0)}else{if(F.toString()=="W"){return(ScaleF16(C)).toFixed(0)}else{if(F.toString()=="Ah"){C<<=16;C>>=16;return(C*0.1).toFixed(1)}else{if(F.toString()=="kWh"){C<<=16;C>>=16;return(C*0.1).toFixed(0)}else{C<<=16;C>>=16;return(C).toFixed(2)}}}}}}}function ScaledValueDisplayClass(B,A,G,E,C,F,D){this.SMBID=B;this.MBaddress=A;this.frmName=C;this.lblName=F;this.ScaleFactor=G;this.ScaleLbl=E;this.updateLVText=function(){try{document.forms[this.frmName].elements.lblDataName.value=this.lblName.toString();document.forms[this.frmName].elements.lblcurrentValue.value=GetScaledValue(this.SMBID,this.MBaddress,this.ScaleFactor,D).toString()+" "+this.ScaleLbl.toString();return 1}catch(H){return 0}}}function ScaledProductDisplayClass(C,B,F,A,E,G,D,H){this.SMBID=C;this.MBaddress1=B;this.MBaddress2=A;this.frmName=D;this.lblName=H;this.ScaleFactor1=F;this.ScaleFactor2=E;this.ScaleStr=G;this.updateLVText=function(){try{document.forms[this.frmName].elements.lblDataName.value=this.lblName.toString();document.forms[this.frmName].elements.lblcurrentValue.value=(Math.round((GetScaledValue(this.SMBID,this.MBaddress1,this.ScaleFactor1,1))*(GetScaledValue(this.SMBID,this.MBaddress2,this.ScaleFactor2,1)),4)).toString()+this.ScaleStr.toString();return 1}catch(I){return 0}}}function updateAllLVText(){clearInterval(intervalHandle);var B=1;var A=0;while((A<rowsToUpdate.length)&&B){B=rowsToUpdate[A].updateLVText();A++}intervalHandle=setInterval(updateAllLVText,UPDATE_FREQ_SECS*1000)};
